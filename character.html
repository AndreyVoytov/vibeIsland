<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Character</title>
  <style>
    html,body{margin:0;height:100%;overflow:hidden;background:transparent}
    canvas{display:block;position:absolute;top:0;left:0;touch-action:none}
  </style>
</head>
<body>
<canvas id="gameCanvas"></canvas>

<script>
/* ---------- логическая сетка ---------- */
const GRID_W = 20;
const GRID_H = 36;

/* ---------- процентные константы ---------- */
const SPEED_PCT   = 0.4;    // %W за кадр
const JOY_R_PCT   = 8;      // радиус джойстика
const CHAR_R_PCT  = 6;      // радиус героя

/* ---------- init ---------- */
const canvas = document.getElementById('gameCanvas');
const ctx    = canvas.getContext('2d');
const map    = JSON.parse(localStorage.getItem('map') || '[]');

let cw,ch,cell,joyR,charR;

const pct2px = p => p * cw / 100;     // %W → px

/* позиция героя в центре острова */
let charXPct = 50;                               // середина по X
let charYPct = (GRID_H / 2) / GRID_W * 100;      // середина по Y в %W
let vxPct = 0, vyPct = 0;

/* ---------- джойстик ---------- */
let joyActive = false, joyCtr = {x:0,y:0}, joyVec={x:0,y:0};

function getPos(e){
  const r = canvas.getBoundingClientRect();
  if(e.touches) e = e.touches[0];
  return {x:e.clientX - r.left, y:e.clientY - r.top};
}
function onDown(e){
  canvas.setPointerCapture(e.pointerId);
  joyActive = true;
  joyCtr = getPos(e);
  joyVec = {x:0,y:0};
}
function onMove(e){
  if(!joyActive) return;
  const p  = getPos(e);
  const dx = p.x - joyCtr.x;
  const dy = p.y - joyCtr.y;
  const max = joyR*0.6;
  const dist = Math.hypot(dx,dy);
  const s = dist>max ? max/dist : 1;
  joyVec = {x:dx*s, y:dy*s};
  vxPct  = (joyVec.x / max) * SPEED_PCT;
  vyPct  = (joyVec.y / max) * SPEED_PCT;
}
function onUp(e){
  canvas.releasePointerCapture(e.pointerId);
  joyActive = false;
  vxPct = vyPct = 0;
  joyVec = {x:0,y:0};
}
canvas.addEventListener('pointerdown',  onDown);
canvas.addEventListener('pointermove',  onMove);
canvas.addEventListener('pointerup',    onUp);
canvas.addEventListener('pointercancel',onUp);

/* ---------- игровой цикл ---------- */
function update(){
  /* пробуем сдвинуть по X отдельно */
  if (vxPct !== 0){
    const nx = charXPct + vxPct;
    const gx = Math.floor(pct2px(nx) / cell);
    const gy = Math.floor(pct2px(charYPct) / cell);
    if (gx>=0 && gx<GRID_W && gy>=0 && gy<GRID_H && map[gy]?.[gx]){
      charXPct = nx;
    }
  }

  /* пробуем сдвинуть по Y отдельно */
  if (vyPct !== 0){
    const ny = charYPct + vyPct;
    const gx = Math.floor(pct2px(charXPct) / cell); // X уже мог измениться
    const gy = Math.floor(pct2px(ny) / cell);
    if (gx>=0 && gx<GRID_W && gy>=0 && gy<GRID_H && map[gy]?.[gx]){
      charYPct = ny;
    }
  }
}

function drawDebugCells(){
  ctx.save();
  ctx.fillStyle='rgba(0,255,0,0.15)';
  for(let y=0;y<GRID_H;y++){
    for(let x=0;x<GRID_W;x++){
      if(map[y][x]){
        ctx.fillRect(x*cell, y*cell, cell, cell);
      }
    }
  }
  ctx.restore();
}

function render(){
  ctx.clearRect(0,0,cw,ch);

  /* DEBUG: зелёные проходимые клетки */
  drawDebugCells();

  /* герой */
  const x = pct2px(charXPct), y = pct2px(charYPct);
  ctx.fillStyle='#ffdc00';
  ctx.beginPath(); ctx.arc(x,y,charR,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#000';
  ctx.beginPath();
  ctx.arc(x-charR*0.33,y-charR*0.25,charR*0.17,0,Math.PI*2);
  ctx.arc(x+charR*0.33,y-charR*0.25,charR*0.17,0,Math.PI*2);
  ctx.fill();

  /* джойстик */
  if(joyActive){
    ctx.save(); ctx.globalAlpha=0.25;
    ctx.fillStyle='#999';
    ctx.beginPath(); ctx.arc(joyCtr.x,joyCtr.y,joyR,0,Math.PI*2); ctx.fill();
    ctx.restore();

    ctx.fillStyle='#ccc';
    ctx.beginPath();
    ctx.arc(joyCtr.x+joyVec.x,joyCtr.y+joyVec.y,joyR*0.4,0,Math.PI*2);
    ctx.fill();
  }
}

function loop(){ update(); render(); requestAnimationFrame(loop); }

/* ---------- resize ---------- */
function resize(){
  cw = canvas.width  = window.innerWidth;
  ch = canvas.height = window.innerHeight;
  cell = cw / GRID_W;

  joyR  = pct2px(JOY_R_PCT);
  charR = pct2px(CHAR_R_PCT);
}
window.addEventListener('resize', resize);
resize(); loop();
</script>
</body>
</html>
