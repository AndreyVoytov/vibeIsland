<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Hero Logic</title>
  <style>html,body{margin:0;height:100%;overflow:hidden;background:transparent}</style>
</head>
<body>
<script>
/* ---------- карта ---------- */
const map = JSON.parse(localStorage.getItem('map') || '[]');
const GRID_H = map.length;
const GRID_W = map[0] ? map[0].length : 0;

/* ---------- положение героя ---------- */
let charXPct = 50;
let charYPct = (GRID_H / 2) / GRID_W * 100;
let facing   = 1;

/* скорость */
const SPEED_SCALE = 1;

/* ---------- обновление координат ---------- */
function update(dtMs){
  const ctrl = JSON.parse(localStorage.getItem('controller') || '{}');
  let vx = (ctrl.vxPct || 0) * SPEED_SCALE;
  let vy = (ctrl.vyPct || 0) * SPEED_SCALE;
  const isMoving = Math.abs(vx) + Math.abs(vy) > 0.001;

  /* коллизии по ногам */
  const vw   = parseFloat(localStorage.getItem('gameWidth')) || innerWidth;
  const cell = vw / GRID_W;
  const pct2px = p => p * vw / 100;

  if (vx){
    const nx = charXPct + vx;
    const gx = Math.floor(pct2px(nx) / cell);
    const gy = Math.floor(pct2px(charYPct) / cell);
    if (gx>=0 && gx<GRID_W && gy>=0 && gy<GRID_H && map[gy]?.[gx]) charXPct = nx;
  }
  if (vy){
    const ny = charYPct + vy;
    const gx = Math.floor(pct2px(charXPct) / cell);
    const gy = Math.floor(pct2px(ny) / cell);
    if (gx>=0 && gx<GRID_W && gy>=0 && gy<GRID_H && map[gy]?.[gx]) charYPct = ny;
  }

  if (Math.abs(vx) > 0.001) facing = vx > 0 ? 1 : -1;

  /* публикуем только координаты + направление + факт движения */
  localStorage.setItem('heroState', JSON.stringify({
    charXPct, charYPct, facing, isMoving
  }));
}

/* ---------- цикл ---------- */
let lastT = performance.now();
function frame(now){
  const dt = now - lastT; lastT = now;
  update(dt);
  requestAnimationFrame(frame);
}
requestAnimationFrame(frame);
</script>
</body>
</html>
