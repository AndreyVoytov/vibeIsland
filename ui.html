<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>UI Layer</title>
  <style>
    :root{
      --panel-bg: rgba(18, 18, 18, 0.9);
      --panel-border: rgba(255, 255, 255, 0.08);
      --card-shadow: 0 8px 16px rgba(0,0,0,0.3);
      font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
      color: #fff;
    }
    html,body{margin:0;height:100%;overflow:hidden;background:transparent;touch-action:none;}
    #uiRoot{position:absolute;inset:0;pointer-events:none;}
    #joystickCanvas{position:absolute;inset:0;pointer-events:none;}
    .money-pill{
      position:absolute;top:14px;right:14px;display:flex;align-items:center;gap:8px;
      background:rgba(0,0,0,0.55);border-radius:999px;padding:6px 12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.35);pointer-events:auto;
    }
    .money-pill img{width:20px;height:20px;display:block;}
    .money-pill span{font-weight:600;font-size:16px;letter-spacing:0.3px;}

    .shop-button{
      position:absolute;bottom:16px;left:50%;transform:translateX(-50%);
      width:180px;height:56px;border-radius:28px;border:none;
      background:linear-gradient(135deg,#e4c18d,#f4dfb5);
      box-shadow:0 6px 14px rgba(0,0,0,0.45);
      display:flex;align-items:center;justify-content:center;cursor:pointer;pointer-events:auto;
    }
    .shop-button img{width:28px;height:28px;filter:drop-shadow(0 2px 2px rgba(0,0,0,0.4));}
    .upgrade-marker{
      position:absolute;top:-6px;right:-6px;width:22px;height:22px;border-radius:999px;
      background:#1ec971;display:flex;align-items:center;justify-content:center;
      box-shadow:0 0 0 2px rgba(0,0,0,0.6);
    }
    .upgrade-marker img{width:14px;height:14px;}
    .upgrade-marker.hidden{display:none;}

    .panel-overlay{
      position:absolute;inset:0;background:rgba(0,0,0,0.35);opacity:0;
      pointer-events:none;transition:0.2s ease;
    }
    .panel-overlay.open{opacity:1;pointer-events:auto;}
    .shop-panel{
      position:absolute;left:50%;bottom:84px;width:min(320px, calc(100% - 24px));max-height:70%;
      background:var(--panel-bg);border-radius:18px;border:1px solid var(--panel-border);
      box-shadow:var(--card-shadow);display:flex;flex-direction:column;overflow:hidden;
      pointer-events:none;transform:translate(-50%, 12px);opacity:0;transition:0.2s ease;
    }
    .shop-panel.open{transform:translate(-50%, 0);opacity:1;pointer-events:auto;}
    .panel-header{
      display:flex;align-items:center;justify-content:space-between;padding:12px 14px;
      background:rgba(255,255,255,0.04);font-weight:600;
    }
    .panel-header button{
      border:none;background:rgba(255,255,255,0.12);color:#fff;border-radius:10px;
      width:28px;height:28px;cursor:pointer;font-size:16px;line-height:1;
    }
    .resource-list{overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:10px;}

    .resource-card{
      display:flex;align-items:center;gap:10px;padding:10px;border-radius:14px;
      background:#2c2c2c;border:1px solid rgba(255,255,255,0.08);
    }
    .resource-card.clickable{cursor:pointer;}
    .resource-card.unlocked{background:linear-gradient(135deg,#b67a1b,#f3c545);}
    .resource-card.available{background:rgba(155, 240, 140, 0.35);}
    .resource-card.locked{background:rgba(140,140,140,0.35);}

    .resource-icon{
      width:42px;height:42px;border-radius:12px;flex-shrink:0;
      background:#ffffff33;display:flex;align-items:center;justify-content:center;
      border:1px solid rgba(255,255,255,0.25);overflow:hidden;
    }
    .resource-icon img{width:100%;height:100%;object-fit:cover;}

    .resource-info{flex:1;display:flex;flex-direction:column;gap:2px;}
    .resource-info span{font-size:14px;}
    .resource-info small{color:rgba(255,255,255,0.7);font-size:12px;}

    .unlock-button{
      border:none;border-radius:12px;padding:6px 10px;font-size:12px;font-weight:600;
      display:flex;align-items:center;gap:6px;cursor:pointer;white-space:nowrap;
      background:#2ecc71;color:#0d2b0f;
    }
    .unlock-button.locked{background:rgba(220, 80, 80, 0.35);color:rgba(255,255,255,0.5);cursor:not-allowed;}
    .unlock-button img{width:16px;height:16px;}
    .check-icon{width:24px;height:24px;}
  </style>
</head>
<body>
  <div id="uiRoot">
    <div class="money-pill">
      <img id="coinIcon" alt="coin" />
      <span id="moneyValue">0</span>
    </div>

    <button id="shopButton" class="shop-button ui-control" aria-label="Открыть магазин" data-ui-control>
      <img id="cartIcon" alt="cart" />
      <span id="upgradeMarker" class="upgrade-marker hidden">
        <img id="arrowIcon" alt="upgrade" />
      </span>
    </button>

    <div id="panelOverlay" class="panel-overlay" data-ui-control></div>
    <div id="shopPanel" class="shop-panel ui-control" aria-hidden="true" data-ui-control>
      <div class="panel-header">
        <span>Магазин ресурсов</span>
        <button id="closePanel" class="ui-control" aria-label="Закрыть" data-ui-control>×</button>
      </div>
      <div id="resourceList" class="resource-list"></div>
    </div>
  </div>
  <canvas id="joystickCanvas"></canvas>

  <script src="./berries-config.js"></script>
  <script src="./ui-config.js"></script>
  <script src="./buildings-config.js"></script>
  <script>
    const uiConfig = window.UIConfig || { uiAssets: {}, resourceEconomy: [] };
    const berryConfig = window.BerriesConfig || { berries: [] };
    const buildingConfig = window.BuildingsConfig || { buildings: [] };
    const svgDataUri = (svg) => `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;

    function buildBuildingFallback(def){
      const primitive = def.primitive || {};
      let svg = "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'>";
      if(primitive.kind === 'campfire'){
        svg += `<ellipse cx='32' cy='42' rx='22' ry='12' fill='${primitive.glow || 'rgba(255,160,80,0.5)'}'/>`;
        svg += `<rect x='14' y='36' width='36' height='14' rx='6' fill='${primitive.stone || '#6e7a86'}'/>`;
        svg += `<path d='M32 18c8 6 10 12 0 22-10-10-8-16 0-22z' fill='${primitive.flame || '#ff8a3d'}'/>`;
      } else if(primitive.kind === 'whetstone'){
        svg += `<rect x='12' y='16' width='40' height='32' rx='8' fill='${primitive.base || '#9da3aa'}'/>`;
        svg += `<rect x='18' y='24' width='28' height='14' rx='6' fill='${primitive.edge || '#dfe5ec'}'/>`;
      } else if(primitive.kind === 'forge'){
        svg += `<rect x='10' y='18' width='44' height='36' rx='8' fill='${primitive.base || '#5b3b2d'}'/>`;
        svg += `<rect x='18' y='10' width='28' height='10' rx='4' fill='${primitive.roof || '#343a40'}'/>`;
        svg += `<rect x='22' y='30' width='20' height='16' rx='4' fill='${primitive.metal || '#c0c7cf'}'/>`;
        svg += `<path d='M32 32c6 4 6 8 0 14-6-6-6-10 0-14z' fill='${primitive.fire || '#ff7a35'}'/>`;
      } else {
        svg += `<rect x='12' y='16' width='40' height='32' rx='8' fill='${primitive.base || '#2f3a4a'}'/>`;
        svg += `<rect x='16' y='12' width='32' height='8' rx='4' fill='${primitive.marker || '#ff6b6b'}'/>`;
      }
      svg += '</svg>';
      return svgDataUri(svg);
    }

    const berryResources = berryConfig.berries.map((def, index) => {
      const econ = uiConfig.resourceEconomy.find((item) => item.id === def.id) || {};
      const profit = typeof econ.profit === 'number' ? econ.profit : index + 1;
      return {
        id: def.id,
        title: def.titleRu || def.id,
        assetUrl: def.assetUrl,
        primitive: def.primitive || {},
        profit,
        unlockCost: typeof econ.unlockCost === 'number' ? econ.unlockCost : 0,
        detail: `Прибыль: +${profit}`,
      };
    });

    const buildingResources = (buildingConfig.buildings || []).map((def) => ({
      id: def.id,
      title: def.titleRu || def.id,
      assetUrl: def.assetUrl,
      primitive: def.primitive || {},
      unlockCost: typeof def.unlockCost === 'number' ? def.unlockCost : 0,
      detail: 'Постройка',
      fallbackUrl: buildBuildingFallback(def),
    }));

    const resources = [...berryResources, ...buildingResources].sort((a, b) => {
      const diff = a.unlockCost - b.unlockCost;
      if(diff !== 0) return diff;
      return a.title.localeCompare(b.title);
    });
    const moneyValue = document.getElementById('moneyValue');
    const shopButton = document.getElementById('shopButton');
    const shopPanel = document.getElementById('shopPanel');
    const closePanel = document.getElementById('closePanel');
    const panelOverlay = document.getElementById('panelOverlay');
    const resourceList = document.getElementById('resourceList');
    const upgradeMarker = document.getElementById('upgradeMarker');
    const resourceCards = new Map();
    const joystickCanvas = document.getElementById('joystickCanvas');
    const joystickCtx = joystickCanvas.getContext('2d');
    const joystickState = {
      joyActive:false,
      joyCtr:{x:0,y:0},
      joyVec:{x:0,y:0},
      vxPct:0,
      vyPct:0
    };
    let joystickPointerId = null;
    let joyCanvasW = 0;
    let joyCanvasH = 0;
    let joyR = 0;
    const JOY_R_PCT = 8;
    const SPEED_PCT = 0.4;

    function saveJoystick(){
      localStorage.setItem('controller', JSON.stringify(joystickState));
    }

    function setImageWithFallback(img, key){
      const asset = uiConfig.uiAssets[key] || {};
      if(asset.url){
        img.src = asset.url;
        img.onerror = () => {
          if(asset.fallback){
            img.src = asset.fallback;
          }
        };
      } else if (asset.fallback) {
        img.src = asset.fallback;
      }
    }

    setImageWithFallback(document.getElementById('coinIcon'), 'coin');
    setImageWithFallback(document.getElementById('cartIcon'), 'cart');
    setImageWithFallback(document.getElementById('arrowIcon'), 'arrowUp');

    function getUserState(){
      let user = {};
      try {
        user = JSON.parse(localStorage.getItem('user') || '{}');
      } catch (err) {
        user = {};
      }
      if(typeof user.money !== 'number' || Number.isNaN(user.money)){
        user.money = 0;
      }
      if(!user.unlockedResources || typeof user.unlockedResources !== 'object'){
        user.unlockedResources = {};
      }
      const defaultUnlocks = [];
      const campfire = buildingResources.find((item) => item.id === 'campfire');
      if(campfire) defaultUnlocks.push(campfire.id);
      if(berryResources[0]) defaultUnlocks.push(berryResources[0].id);
      defaultUnlocks.forEach((id) => {
        user.unlockedResources[id] = true;
      });
      localStorage.setItem('user', JSON.stringify(user));
      return user;
    }

    function setUserState(user){
      localStorage.setItem('user', JSON.stringify(user));
    }

    function attemptUnlock(res){
      const latest = getUserState();
      if(latest.unlockedResources[res.id]) return false;
      if(latest.money < res.unlockCost) return false;
      latest.money -= res.unlockCost;
      latest.unlockedResources[res.id] = true;
      setUserState(latest);
      renderResources();
      return true;
    }

    function isUiControlTarget(target){
      if(!target || !(target instanceof HTMLElement)){
        return false;
      }
      return Boolean(target.closest('[data-ui-control]'));
    }

    function getJoystickPos(e){
      const rect = joystickCanvas.getBoundingClientRect();
      return { x: e.clientX - rect.left, y: e.clientY - rect.top };
    }

    function setJoystickSize(){
      const dpr = window.devicePixelRatio || 1;
      const width = innerWidth;
      const height = innerHeight;
      joystickCanvas.style.width = `${width}px`;
      joystickCanvas.style.height = `${height}px`;
      joystickCanvas.width = Math.round(width * dpr);
      joystickCanvas.height = Math.round(height * dpr);
      joystickCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
      joyCanvasW = width;
      joyCanvasH = height;
      joyR = (JOY_R_PCT * joyCanvasW) / 100;
    }

    function onJoyDown(e){
      if(joystickPointerId !== null) return;
      if(isUiControlTarget(e.target)) return;
      joystickPointerId = e.pointerId ?? 'mouse';
      const pos = getJoystickPos(e);
      joystickState.joyActive = true;
      joystickState.joyCtr = pos;
      joystickState.joyVec = {x:0,y:0};
      joystickState.vxPct = 0;
      joystickState.vyPct = 0;
      saveJoystick();
      e.preventDefault();
    }

    function onJoyMove(e){
      if(!joystickState.joyActive) return;
      if(joystickPointerId !== null && e.pointerId !== joystickPointerId) return;
      const pos = getJoystickPos(e);
      const dx = pos.x - joystickState.joyCtr.x;
      const dy = pos.y - joystickState.joyCtr.y;
      const dist = Math.hypot(dx, dy);
      const max = joyR * 0.6;
      const clamp = dist > max ? max / dist : 1;
      joystickState.joyVec = { x: dx * clamp, y: dy * clamp };
      if(dist > 1e-3){
        const k = SPEED_PCT / dist;
        joystickState.vxPct = dx * k;
        joystickState.vyPct = dy * k;
      } else {
        joystickState.vxPct = 0;
        joystickState.vyPct = 0;
      }
      saveJoystick();
      e.preventDefault();
    }

    function onJoyUp(e){
      if(joystickPointerId !== null && e.pointerId !== joystickPointerId) return;
      joystickPointerId = null;
      joystickState.joyActive = false;
      joystickState.joyVec = {x:0,y:0};
      joystickState.vxPct = 0;
      joystickState.vyPct = 0;
      saveJoystick();
    }

    function renderJoystick(){
      joystickCtx.clearRect(0,0,joyCanvasW,joyCanvasH);
      if(joystickState.joyActive){
        joystickCtx.save();
        joystickCtx.globalAlpha = 0.25;
        joystickCtx.fillStyle = '#999';
        joystickCtx.beginPath();
        joystickCtx.arc(joystickState.joyCtr.x, joystickState.joyCtr.y, joyR, 0, Math.PI * 2);
        joystickCtx.fill();
        joystickCtx.restore();

        joystickCtx.fillStyle = '#ccc';
        joystickCtx.beginPath();
        joystickCtx.arc(
          joystickState.joyCtr.x + joystickState.joyVec.x,
          joystickState.joyCtr.y + joystickState.joyVec.y,
          joyR * 0.4,
          0,
          Math.PI * 2
        );
        joystickCtx.fill();
      }
      requestAnimationFrame(renderJoystick);
    }

    function createResourceCard(res){
      const card = document.createElement('div');
      card.setAttribute('data-ui-control', '');
      card.addEventListener('click', (event) => {
        if(event.target.closest('button')) return;
        attemptUnlock(res);
      });

      const icon = document.createElement('div');
      icon.className = 'resource-icon';
      const img = document.createElement('img');
      img.alt = res.title;
      img.src = res.assetUrl || res.fallbackUrl || '';
      img.onerror = () => {
        if(res.fallbackUrl && img.src !== res.fallbackUrl){
          img.src = res.fallbackUrl;
          return;
        }
        const fallbackAsset = uiConfig.uiAssets.resourceFallback || {};
        const fallbackUrl = fallbackAsset.url || fallbackAsset.fallback;
        if(fallbackUrl && img.src !== fallbackUrl){
          img.src = fallbackUrl;
          return;
        }
        icon.style.background = '#ffffff33';
        icon.innerHTML = '';
      };
      icon.appendChild(img);

      const info = document.createElement('div');
      info.className = 'resource-info';
      const title = document.createElement('span');
      title.textContent = res.title;
      const profit = document.createElement('small');
      profit.textContent = res.detail || `Прибыль: +${res.profit}`;
      info.appendChild(title);
      info.appendChild(profit);

      const button = document.createElement('button');
      button.className = 'unlock-button';
      const coin = document.createElement('img');
      setImageWithFallback(coin, 'coin');
      const label = document.createElement('span');
      button.appendChild(coin);
      button.appendChild(label);
      button.addEventListener('click', (event) => {
        event.stopPropagation();
        attemptUnlock(res);
      });

      const check = document.createElement('img');
      check.className = 'check-icon';
      check.alt = 'unlocked';
      setImageWithFallback(check, 'check');

      card.appendChild(icon);
      card.appendChild(info);
      card.appendChild(button);
      card.appendChild(check);
      resourceList.appendChild(card);

      return { card, button, label, check };
    }

    function renderResources(){
      const user = getUserState();
      moneyValue.textContent = user.money;

      let canUpgrade = false;

      resources.forEach((res) => {
        const unlocked = !!user.unlockedResources[res.id];
        const canBuy = user.money >= res.unlockCost && !unlocked;
        if(canBuy) canUpgrade = true;

        let entry = resourceCards.get(res.id);
        if(!entry){
          entry = createResourceCard(res);
          resourceCards.set(res.id, entry);
        }

        entry.card.className = 'resource-card ' + (unlocked ? 'unlocked' : canBuy ? 'available clickable' : 'locked');
        entry.label.textContent = res.unlockCost;
        entry.button.className = 'unlock-button' + (canBuy ? '' : ' locked');
        entry.button.disabled = !canBuy;
        entry.button.style.display = unlocked ? 'none' : 'flex';
        entry.check.style.display = unlocked ? 'block' : 'none';
      });

      upgradeMarker.classList.toggle('hidden', !canUpgrade);
    }

    function togglePanel(forceOpen){
      const open = typeof forceOpen === 'boolean' ? forceOpen : !shopPanel.classList.contains('open');
      shopPanel.classList.toggle('open', open);
      shopPanel.setAttribute('aria-hidden', (!open).toString());
      panelOverlay.classList.toggle('open', open);
    }

    saveJoystick();
    setJoystickSize();
    requestAnimationFrame(renderJoystick);
    window.addEventListener('resize', setJoystickSize);
    window.addEventListener('pointerdown', onJoyDown, { passive: false });
    window.addEventListener('pointermove', onJoyMove, { passive: false });
    window.addEventListener('pointerup', onJoyUp);
    window.addEventListener('pointercancel', onJoyUp);

    shopButton.addEventListener('click', () => togglePanel());
    closePanel.addEventListener('click', () => togglePanel(false));
    panelOverlay.addEventListener('click', () => togglePanel(false));

    renderResources();
    setInterval(renderResources, 400);
    window.addEventListener('storage', renderResources);
  </script>
</body>
</html>
